<!-- TALES template header -->
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<!-- Microdata markup added by Google Structured Data Markup Helper. -->
<html class="js inlinesvg">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="pandoc" />
    <title>Sisifo - Wearable data upstream</title>
    <meta name="description" content=""/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!-- Bootstrap styles -->
    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap-theme.min.css"/>

    <!-- Font-Awesome -->
    <link rel="stylesheet" href="node_modules/font-awesome/css/font-awesome.min.css"/>

    <!-- Google Webfonts -->
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600%7CPT+Serif:400,400italic' rel='stylesheet' type='text/css'/>

    <!-- Styles -->
    <link rel="stylesheet" href="css/styles-bluegreen.css" id="theme-styles"/>

    <!--[if lt IE 9]>
        <script src="modules/respond/html5-3.6-respond-1.1.0.min.js"></script>
    <![endif]-->

    <script src="//code.jquery.com/jquery-2.2.1.min.js"></script>
    <script>window.jQuery || document.write('<script src="node_modules/jquery/dist/jquery.min.js"><\/script>')</script>

    <!-- end of TALES template header -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XKKHYNWVMZ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-XKKHYNWVMZ');
    </script>


<!-- R markdown title and rest of head tag -->
<title>Upstreaming data from a wearable device to a server: an Android app for a data lab</title>

</head>

<!-- end of R markdown title and rest of head tag -->



<!-- back to TALES template, close header and tab for body -->
<body>

  <header>
      <div class="widewrapper masthead">
          <div class="container">
              <a href="index.html" id="logo">
                  Sisifo's page
                  <!--Use the following line instead if you want to use an image logo-->
                  <!--<img src="img/tales-logo.png" alt="Tales Blog">-->
              </a>

              <div id="mobile-nav-toggle" class="pull-right">
                  <a href="#" data-toggle="collapse" data-target=".tales-nav .navbar-collapse">
                      <i class="fa fa-bars"></i>
                  </a>
              </div>

              <nav class="pull-right tales-nav">
                  <div class="collapse navbar-collapse">
                      <ul class="nav nav-pills navbar-nav">
                          <li>
                              <a href="index.html">Blog</a>
                          </li>
                          <li>
                              <a href="about.html">About</a>
                          </li>
                          <li>
                              <a href="credits.html">Credits</a>
                          </li>
                      </ul>
                  </div>
              </nav>

          </div>
      </div>

      <div class="widewrapper subheader">
          <div class="container">
              <div class="tales-breadcrumb">
                  <a href="index.html">Blog</a>
                  <span class="separator">&#x2F;</span>
                  <a href="#">Wearable data upstream</a>
              </div>

              <div class="tales-searchbox">
                  <form action="#" method="get" accept-charset="utf-8">
                      <button class="searchbutton" type="submit">
                          <i class="fa fa-search"></i>
                      </button>
                      <input class="searchfield" id="searchbox" type="text" placeholder="Search">
                  </form>
              </div>
          </div>
      </div>
  </header>
  <!-- end of body header for TALES template, back to R markdown -->


  <span itemscope itemtype="http://schema.org/Article">
    <div class="container-fluid main-container">

    <style type="text/css">
    .main-container {
      max-width: 940px;
      margin-left: auto;
      margin-right: auto;
    }
    code {
      color: inherit;
      background-color: rgba(0, 0, 0, 0.04);
    }
    img {
      max-width:100%;
      height: auto;
    }
    h1 {
      font-size: 34px;
    }
    h1.title {
      font-size: 38px;
    }
    h2 {
      font-size: 30px;
    }
    h3 {
      font-size: 24px;
    }
    h4 {
      font-size: 18px;
    }
    h5 {
      font-size: 16px;
    }
    h6 {
      font-size: 12px;
    }
    .tabbed-pane {
      padding-top: 12px;
    }
    button.code-folding-btn:focus {
      outline: none;
    }
    </style>


  <div class="fluid-row" id="header">

    <h1 class="title"><span itemprop="name">Upstreaming data from a wearable device to a server: an Android app for a data lab</span></h1>
    <!-- TALES added date of post & Structured data -->
    <div class="meta clearfix">
        <div class="date">
            <i class="fa fa-calendar"></i>
            <span itemprop="datePublished" content="2016-08-09" class="data">9 Aug 2016</span>
        </div>
    </div>
    <span style="display: none"><!-- Structured Data -->
      <span itemprop="author" itemtype="http://schema.org/Person">
        <span itemprop="name">sisifospage@gmail.com</span>
      </span>
      <span itemprop="image" itemscope itemtype="http://schema.org/ImageObject">
        <a itemprop="url" href="http://sisifospage.tech/img/tom-Boiling-point-of-water-300px.png"></a>
        <span itemprop="height">300</span>
        <span itemprop="width">139</span>
      </span>
      <span itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
        <span itemprop="name">Sisifo's Page</span>
        <span itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
          <a itemprop="url" href="http://sisifospage.tech/img/Frankenstein-300px.png"></a>
        </span>
      </span>
      <span itemprop="headline" style="display: none">getting data from a wearable upstream, Android app, data lab, accelerometer data analysis</span></a></h3>
      <span itemprop="dateModified" content="2016-10-31" class="meta">31 Oct 2016</span>
      <span itemprop="mainEntityOfPage" itemscope itemtype="http://schema.org/WebPage">
        <!--<span itemprop="id">href="http://lrnzcig.github.io</span>-->
      </span>
      <img src="http://sisifospage.tech/img/tom-Boiling-point-of-water-300px.png" alt="user" height="300" width="139">
    </span>
    <!-- end of TALES added date of post -->


  </div>

  <h3>Introduction &amp; purpose</h3>
  <p>This post is more related to the data engineering side of things, rather than the analytics, at least first sight. At the end, indeed it
    is about an Android app!
    The point is, we've been for quite some time now preparing a data laboratory, and our intention is to buy pretty soon one or two dozens of wristbands,
    have some people wear them for a few hours a day, upstream all the data to a database in a server, and then analyze the data to find insights.</p>
  <p>Everything you would need for building such a lab is pretty much available: there's several providers for the hardware of the wristband, which also give an Android
    app to communicate with it. And Android itself has open and well documented libraries for nearly everything you need, thus it should be fairly easy to enhance the
    provider's app to your purpose. However, the sensors in the wristband produce an amount of data that is not negligible, i.e. if you want
    to process the raw data (commercial products pre-process the sensors' data in the hardware of the wristband, and only accumulated results go to the app in your
    smartphone). Besides, upstreaming is not really so common in any Android development, at least not in a fast and continuous manner. Thus, finally it was
    not so easy to prepare the app for the lab, and that's why we thought it could make a hopefully interesting and useful post.</p>
  <p>This post aims to explain the details of such an app, with code snippets and links to the full solution, and being agnostic about the hardware.</p>
  <h3>A cache object and an upstream service</h3>
  <p>In this post you will find the description of two main objects of the app:</p>
  <ul>
    <li>A cache object that stores the data from the wearable in an array in memory, so that the access is very fast.
      Periodically, the cache takes the elements from its buffers and stores them in a SQLite in-memory database</li>
    <li>An upstream service, which takes care of the communication with the server, regularly uploading the data from the SQLite
      database into the server via a REST API</li>
  </ul>
  <p>The complete app (see <a href="https://github.com/lrnzcig/fraa/tree/master/FraaStream">here</a> for the full code), contains several Android Activities
    which handle the interaction with the user and the connection with the device. The cache is tightly linked to one of the activities, while the
    communication with the server is implemented as an Android Service. (Note that, in Android development, an Activity runs in the foreground and serves
    as the user's GUI, while a Service implements something that the user does not see directly, but it is important for the app, see
    <a href="https://developer.android.com/guide/components/processes-and-threads.html">here</a> for more details.)</p>
  <h4>The cache in detail, including code snippets</h4>
  <p>You can find the full implementation of the object <a href="https://github.com/lrnzcig/fraa/blob/master/FraaStream/app/src/main/java/tech/sisifospage/fraastream/cache/AccDataCacheSingleton.java">here</a>.
    Main features follow as bullet list.</p>
  <ul>
    <li>It is implemented as a singleton, which means there is a unique instance of the object in the app -thus the unique and same instance may be
      retrieved from either the Activity handling the interaction with the user and the hardware, or from the Upstream Service. However, note that
      only the Activity will actually create the new instance; the Service will just fetch it. Also note ahta the context of the Android Activity
      is stored -will be used for establishing the connection with the SQLite database, and also in the Service
    </li>
  </ul>
  <!-- HTML generated using hilite.me --><div style="background: #f8f8f8; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">synchronized</span> <span style="color: #008000; font-weight: bold">static</span> AccDataCacheSingleton <span style="color: #0000FF">getInstance</span><span style="color: #666666">(</span>Context context<span style="color: #666666">)</span> <span style="color: #666666">{</span>
          <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>accDataCacheSingleton <span style="color: #666666">==</span> <span style="color: #008000; font-weight: bold">null</span> <span style="color: #666666">&amp;&amp;</span> context <span style="color: #666666">!=</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
              Log<span style="color: #666666">.</span><span style="color: #7D9029">d</span><span style="color: #666666">(</span>TAG<span style="color: #666666">,</span> <span style="color: #BA2121">&quot;Creating cache singleton&quot;</span><span style="color: #666666">);</span>
              accDataCacheSingleton <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> AccDataCacheSingleton<span style="color: #666666">();</span>
              accDataCacheSingleton<span style="color: #666666">.</span><span style="color: #7D9029">context</span> <span style="color: #666666">=</span> context<span style="color: #666666">;</span>
              accDataCacheSingleton<span style="color: #666666">.</span><span style="color: #7D9029">initBuffer</span><span style="color: #666666">();</span>
          <span style="color: #666666">}</span>
          <span style="color: #008000; font-weight: bold">return</span> accDataCacheSingleton<span style="color: #666666">;</span>
      <span style="color: #666666">}</span>
  </pre></div>

  <ul><li>Additionally, there is a call to a method to inizialize the buffers
    </li>
  </ul>
    <!-- HTML generated using hilite.me --><div style="background: #f8f8f8; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">initBuffer</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
            togglingBuffer <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> Buffer<span style="color: #666666">[</span>TOGGLING_BUFFER_SIZE<span style="color: #666666">];</span>
            bufferPointer <span style="color: #666666">=</span> <span style="color: #666666">0;</span>
            unitsPointer <span style="color: #666666">=</span> <span style="color: #666666">0;</span>
            bufferBackupPending <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> HashMap<span style="color: #666666">&lt;&gt;();</span>
            togglingBuffer<span style="color: #666666">[</span>accDataCacheSingleton<span style="color: #666666">.</span><span style="color: #7D9029">bufferPointer</span><span style="color: #666666">]</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> Buffer<span style="color: #666666">();</span>
        <span style="color: #666666">}</span>
    </pre></div>

  <ul>
    <li>The cache receives requests from the main activity to add data from the sensor. Note that these data come one by one, and at a relatively high
      rate. For example, in the case of an accelerometer, it may be between 10 and 50 samples per second, each of them with the 3 position coordinates. The
      cache stores the data in a buffer and responds fast</li>
  </ul>
  <!-- HTML generated using hilite.me --><div style="background: #f8f8f8; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">synchronized</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">add</span><span style="color: #666666">(</span>FraaStreamDataUnit unit<span style="color: #666666">)</span> <span style="color: #666666">{</span>
          <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>unitsPointer <span style="color: #666666">==</span> LENGTH_OF_BUFFER<span style="color: #666666">)</span> <span style="color: #666666">{</span>
              Log<span style="color: #666666">.</span><span style="color: #7D9029">e</span><span style="color: #666666">(</span>TAG<span style="color: #666666">,</span> <span style="color: #BA2121">&quot;Error, index has been skipped!!!&quot;</span><span style="color: #666666">);</span>
              toggleBuffer<span style="color: #666666">();</span>
          <span style="color: #666666">}</span>
          togglingBuffer<span style="color: #666666">[</span>bufferPointer<span style="color: #666666">].</span><span style="color: #7D9029">units</span><span style="color: #666666">[</span>unitsPointer<span style="color: #666666">++]</span> <span style="color: #666666">=</span> unit<span style="color: #666666">;</span>
          <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>unitsPointer <span style="color: #666666">==</span> LENGTH_OF_BUFFER<span style="color: #666666">)</span> <span style="color: #666666">{</span>
              Log<span style="color: #666666">.</span><span style="color: #7D9029">d</span><span style="color: #666666">(</span>TAG<span style="color: #666666">,</span> <span style="color: #BA2121">&quot;Recreating singleton buffer&quot;</span><span style="color: #666666">);</span>
              UUID id <span style="color: #666666">=</span> toggleBuffer<span style="color: #666666">();</span>
              <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">InsertIntoDatabaseTask</span><span style="color: #666666">().</span><span style="color: #7D9029">execute</span><span style="color: #666666">(</span>id<span style="color: #666666">.</span><span style="color: #7D9029">toString</span><span style="color: #666666">());</span>
          <span style="color: #666666">}</span>
      <span style="color: #666666">}</span>
  </pre></div>

  <ul><li>Additionally, when the buffer is full, the cache toggles to a second buffer for adding new data, and flushes the data of the first buffer into
    the SQLite database.
    This is the method that toggles the buffers when the active buffer gets full. It uses the database semaphore to guarantee that no other process accesses to
    <font style="background-color: lightgrey">bufferBackupPending</font> at the same time (being the async insertions to the database the other process that may access it, see below)
  </li></ul>
    <!-- HTML generated using hilite.me --><div style="background: #f8f8f8; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Buffer</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">public</span> FraaStreamDataUnit<span style="color: #666666">[]</span> units<span style="color: #666666">;</span>

            <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">Buffer</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
                <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">units</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> FraaStreamDataUnit<span style="color: #666666">[</span>LENGTH_OF_BUFFER<span style="color: #666666">];</span>
            <span style="color: #666666">}</span>
        <span style="color: #666666">}</span>

        <span style="color: #008000; font-weight: bold">private</span> UUID <span style="color: #0000FF">toggleBuffer</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>bufferBackupPending<span style="color: #666666">.</span><span style="color: #7D9029">get</span><span style="color: #666666">(</span>bufferPointer<span style="color: #666666">)</span> <span style="color: #666666">!=</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
                Log<span style="color: #666666">.</span><span style="color: #7D9029">e</span><span style="color: #666666">(</span>TAG<span style="color: #666666">,</span> <span style="color: #BA2121">&quot;Data would get lost in this case... consider adding a semaphore?&quot;</span><span style="color: #666666">);</span>
            <span style="color: #666666">}</span>
            UUID id <span style="color: #666666">=</span> UUID<span style="color: #666666">.</span><span style="color: #7D9029">randomUUID</span><span style="color: #666666">();</span>
            <span style="color: #408080; font-style: italic">// use database semaphore...</span>
            getDbHelperWhenAvailable<span style="color: #666666">();</span>
            bufferBackupPending<span style="color: #666666">.</span><span style="color: #7D9029">put</span><span style="color: #666666">(</span>bufferPointer<span style="color: #666666">++,</span> id<span style="color: #666666">);</span>
            release<span style="color: #666666">();</span>
            bufferPointer <span style="color: #666666">=</span> <span style="color: #666666">(</span>bufferPointer <span style="color: #666666">==</span> TOGGLING_BUFFER_SIZE<span style="color: #666666">)</span> <span style="color: #666666">?</span> <span style="color: #666666">0</span> <span style="color: #666666">:</span> bufferPointer<span style="color: #666666">;</span>
            togglingBuffer<span style="color: #666666">[</span>bufferPointer<span style="color: #666666">]</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> Buffer<span style="color: #666666">();</span>
            unitsPointer <span style="color: #666666">=</span> <span style="color: #666666">0;</span>
            <span style="color: #008000; font-weight: bold">return</span> id<span style="color: #666666">;</span>
        <span style="color: #666666">}</span>
    </pre></div>

  <ul><li>While the following method, invoked after toggling, inserts the data of the full buffer into SQLite as an asynchronous task (thus the Activity does not
    need to wait for it to finish):</li></ul>
    <!-- HTML generated using hilite.me --><div style="background: #f8f8f8; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">InsertIntoDatabaseTask</span> <span style="color: #008000; font-weight: bold">extends</span> AsyncTask<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> Integer<span style="color: #666666">,</span> Integer<span style="color: #666666">&gt;</span> <span style="color: #666666">{</span>
            <span style="color: #AA22FF">@Override</span>
            <span style="color: #008000; font-weight: bold">protected</span> Integer <span style="color: #0000FF">doInBackground</span><span style="color: #666666">(</span>String<span style="color: #666666">...</span> params<span style="color: #666666">)</span> <span style="color: #666666">{</span>
                UUID id <span style="color: #666666">=</span> UUID<span style="color: #666666">.</span><span style="color: #7D9029">fromString</span><span style="color: #666666">(</span>params<span style="color: #666666">[0]);</span>
                Integer bufferToBackup <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">;</span>
                FraaDbHelper fraaDbHelper <span style="color: #666666">=</span> getDbHelperWhenAvailable<span style="color: #666666">();</span>
                SQLiteDatabase db <span style="color: #666666">=</span> fraaDbHelper<span style="color: #666666">.</span><span style="color: #7D9029">getWritableDatabase</span><span style="color: #666666">();</span>
                <span style="color: #008000; font-weight: bold">for</span> <span style="color: #666666">(</span>Integer key <span style="color: #666666">:</span> bufferBackupPending<span style="color: #666666">.</span><span style="color: #7D9029">keySet</span><span style="color: #666666">())</span> <span style="color: #666666">{</span>
                    UUID candidate <span style="color: #666666">=</span> bufferBackupPending<span style="color: #666666">.</span><span style="color: #7D9029">get</span><span style="color: #666666">(</span>key<span style="color: #666666">);</span>
                    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>candidate <span style="color: #666666">!=</span> <span style="color: #008000; font-weight: bold">null</span> <span style="color: #666666">&amp;&amp;</span> candidate<span style="color: #666666">.</span><span style="color: #7D9029">equals</span><span style="color: #666666">(</span>id<span style="color: #666666">))</span> <span style="color: #666666">{</span>
                        bufferToBackup <span style="color: #666666">=</span> key<span style="color: #666666">;</span>
                    <span style="color: #666666">}</span>
                <span style="color: #666666">}</span>
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>bufferToBackup <span style="color: #666666">==</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
                    Log<span style="color: #666666">.</span><span style="color: #7D9029">e</span><span style="color: #666666">(</span>TAG<span style="color: #666666">,</span> <span style="color: #BA2121">&quot;Data got lost... Don&#39;t find &quot;</span> <span style="color: #666666">+</span> id<span style="color: #666666">.</span><span style="color: #7D9029">toString</span><span style="color: #666666">()</span> <span style="color: #666666">+</span> <span style="color: #BA2121">&quot; anymore&quot;</span><span style="color: #666666">);</span>
                <span style="color: #666666">}</span>

                <span style="color: #008000; font-weight: bold">for</span> <span style="color: #666666">(</span>FraaStreamDataUnit unit <span style="color: #666666">:</span> togglingBuffer<span style="color: #666666">[</span>bufferToBackup<span style="color: #666666">].</span><span style="color: #7D9029">units</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
                    <span style="color: #408080; font-style: italic">//Log.d(StreamingActivity.TAG, &quot;count:&quot; + count++);</span>
                    ContentValues values <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> ContentValues<span style="color: #666666">();</span>
                    values<span style="color: #666666">.</span><span style="color: #7D9029">put</span><span style="color: #666666">(</span>AccDataContract<span style="color: #666666">.</span><span style="color: #7D9029">AccDataEntry</span><span style="color: #666666">.</span><span style="color: #7D9029">COLUMN_NAME_HEADER_ID</span><span style="color: #666666">,</span> getHeaderId<span style="color: #666666">());</span>
                    values<span style="color: #666666">.</span><span style="color: #7D9029">put</span><span style="color: #666666">(</span>AccDataContract<span style="color: #666666">.</span><span style="color: #7D9029">AccDataEntry</span><span style="color: #666666">.</span><span style="color: #7D9029">COLUMN_NAME_INDEX</span><span style="color: #666666">,</span> unit<span style="color: #666666">.</span><span style="color: #7D9029">getIndex</span><span style="color: #666666">());</span>
                    values<span style="color: #666666">.</span><span style="color: #7D9029">put</span><span style="color: #666666">(</span>AccDataContract<span style="color: #666666">.</span><span style="color: #7D9029">AccDataEntry</span><span style="color: #666666">.</span><span style="color: #7D9029">COLUMN_NAME_X</span><span style="color: #666666">,</span> unit<span style="color: #666666">.</span><span style="color: #7D9029">getX</span><span style="color: #666666">());</span>
                    values<span style="color: #666666">.</span><span style="color: #7D9029">put</span><span style="color: #666666">(</span>AccDataContract<span style="color: #666666">.</span><span style="color: #7D9029">AccDataEntry</span><span style="color: #666666">.</span><span style="color: #7D9029">COLUMN_NAME_Y</span><span style="color: #666666">,</span> unit<span style="color: #666666">.</span><span style="color: #7D9029">getY</span><span style="color: #666666">());</span>
                    values<span style="color: #666666">.</span><span style="color: #7D9029">put</span><span style="color: #666666">(</span>AccDataContract<span style="color: #666666">.</span><span style="color: #7D9029">AccDataEntry</span><span style="color: #666666">.</span><span style="color: #7D9029">COLUMN_NAME_Z</span><span style="color: #666666">,</span> unit<span style="color: #666666">.</span><span style="color: #7D9029">getZ</span><span style="color: #666666">());</span>
                    db<span style="color: #666666">.</span><span style="color: #7D9029">insert</span><span style="color: #666666">(</span>AccDataContract<span style="color: #666666">.</span><span style="color: #7D9029">AccDataEntry</span><span style="color: #666666">.</span><span style="color: #7D9029">TABLE_NAME</span><span style="color: #666666">,</span>
                            <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">,</span>
                            values<span style="color: #666666">);</span>
                <span style="color: #666666">}</span>

                <span style="color: #408080; font-style: italic">//db.endTransaction();</span>
                bufferBackupPending<span style="color: #666666">.</span><span style="color: #7D9029">put</span><span style="color: #666666">(</span>bufferToBackup<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">);</span>
                Log<span style="color: #666666">.</span><span style="color: #7D9029">d</span><span style="color: #666666">(</span>TAG<span style="color: #666666">,</span> <span style="color: #BA2121">&quot;copy to SQLite ok (&quot;</span> <span style="color: #666666">+</span> bufferToBackup <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;)&quot;</span><span style="color: #666666">);</span>
                db<span style="color: #666666">.</span><span style="color: #7D9029">close</span><span style="color: #666666">();</span>
                release<span style="color: #666666">();</span>
                <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">1;</span>
            <span style="color: #666666">}</span>
        <span style="color: #666666">}</span>
    </pre></div>

  <ul>
    <li>Finally, it is important to note that the cache object handles every access to the SQLite database, also the ones that are required by
      the upstream service. That way, since all accesses are handled in a single object, contention can be avoided (since SQLite implementation
      in Android may fail in concurrent accesses). The access to the database is protected through a simple semaphore in our current
      implementation, so that only one process can access it at a time:</li>
  </ul>
  <!-- HTML generated using hilite.me --><div style="background: #f8f8f8; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> Semaphore available <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> Semaphore<span style="color: #666666">(1);</span>

    <span style="color: #008000; font-weight: bold">private</span> FraaDbHelper <span style="color: #0000FF">getDbHelperWhenAvailable</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        available<span style="color: #666666">.</span><span style="color: #7D9029">acquireUninterruptibly</span><span style="color: #666666">();</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">FraaDbHelper</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">context</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>
  </pre></div>
  <h4>The upstream service in detail, including code snippets</h4>
  <p>The upstream service periodically uploads the available data into the server. As stated above, every time it needs to access the SQLite database,
    it asks it to the cache object (a unique singleton instance). Note that:</p>
    <ul>
      <li>The object extends an Android Service, and only implements a few methods with the actual functionality. Hint: when you create a service,
        do it with Android Studio, so that the tools take care of the modifications to the manifest and gradle scripts</li>
      <li>The requests are done using <a href="https://developer.android.com/training/volley/index.html">volley</a>, a very handy Android library for
        REST accesses; however, since most of the common accesses are downstream (not upstream), the library is not as straightforward to use as in other
        cases. Still, it makes it pretty easy</li>
      <li>Since the cache is a singleton, the communication between the service and the cache is direct. The upstream service will get the instance of
        the cache that the Activity has created -anyhow only the Activity, not the service, will initialize the cache.
        (Recall that the Activity handles the interaction with the user an the hardware. Usually in Android, when communicating an Activity with a Service,
        a Service Intent object is used, but in this case it is not needed)
    </ul>
  <p>You can find the full implementation of the object
    <a href="https://github.com/lrnzcig/fraa/blob/master/FraaStream/app/src/main/java/tech/sisifospage/fraastream/stream/UpstreamService.java">here</a>.
    Main features follow as bullet list.</p>
  <ul>
    <li>The following method sends a bunch of data upstream to the server. It uses Google's <a href="https://github.com/google/gson">gson</a> for
      serialization. Most of the logic is implemented as a volley custom request (since it is upstream and with particular data type), following
      <a href="https://developer.android.com/training/volley/request-custom.html">this guidelines</a> and implemented in a generic object called
      <a href="https://github.com/lrnzcig/fraa/blob/master/FraaStream/app/src/main/java/tech/sisifospage/fraastream/stream/GsonRequest.java">GsonRequest</a>.
      Once this object is implemented, each of the requests just needs to describe what to do when the request is either successful or fails</li>
  </ul>
  <!-- HTML generated using hilite.me --><div style="background: #f8f8f8; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">sendToServer</span><span style="color: #666666">(</span>FraaStreamData data<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        RequestQueue queue <span style="color: #666666">=</span> Volley<span style="color: #666666">.</span><span style="color: #7D9029">newRequestQueue</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">);</span>
        String url <span style="color: #666666">=</span> server_url <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;data&quot;</span><span style="color: #666666">;</span>
        GsonRequest postRequest <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> GsonRequest<span style="color: #666666">&lt;</span>FraaStreamData<span style="color: #666666">,</span> UUID<span style="color: #666666">&gt;(</span>Request<span style="color: #666666">.</span><span style="color: #7D9029">Method</span><span style="color: #666666">.</span><span style="color: #7D9029">POST</span><span style="color: #666666">,</span> url<span style="color: #666666">,</span> data<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">,</span>
                <span style="color: #008000; font-weight: bold">new</span> Response<span style="color: #666666">.</span><span style="color: #7D9029">Listener</span><span style="color: #666666">&lt;</span>UUID<span style="color: #666666">&gt;()</span> <span style="color: #666666">{</span>
                    <span style="color: #AA22FF">@Override</span>
                    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">onResponse</span><span style="color: #666666">(</span>UUID response<span style="color: #666666">)</span> <span style="color: #666666">{</span>
                        Log<span style="color: #666666">.</span><span style="color: #7D9029">i</span><span style="color: #666666">(</span>StreamingActivity<span style="color: #666666">.</span><span style="color: #7D9029">TAG</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;Response id to be removed: &quot;</span> <span style="color: #666666">+</span> response <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;(&quot;</span> <span style="color: #666666">+</span> pendingRequests<span style="color: #666666">.</span><span style="color: #7D9029">get</span><span style="color: #666666">(</span>response<span style="color: #666666">).</span><span style="color: #7D9029">getHeaderId</span><span style="color: #666666">()</span> <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;)&quot;</span><span style="color: #666666">);</span>
                        <span style="color: #408080; font-style: italic">// update new serverHeaderId</span>
                        AccDataCacheSingleton obj <span style="color: #666666">=</span> AccDataCacheSingleton<span style="color: #666666">.</span><span style="color: #7D9029">getInstance</span><span style="color: #666666">();</span>
                        obj<span style="color: #666666">.</span><span style="color: #7D9029">removeFromDatabase</span><span style="color: #666666">(</span>pendingRequests<span style="color: #666666">.</span><span style="color: #7D9029">get</span><span style="color: #666666">(</span>response<span style="color: #666666">));</span>
                        Log<span style="color: #666666">.</span><span style="color: #7D9029">i</span><span style="color: #666666">(</span>StreamingActivity<span style="color: #666666">.</span><span style="color: #7D9029">TAG</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;Response id finished removing: &quot;</span> <span style="color: #666666">+</span> response <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;(&quot;</span> <span style="color: #666666">+</span> pendingRequests<span style="color: #666666">.</span><span style="color: #7D9029">get</span><span style="color: #666666">(</span>response<span style="color: #666666">).</span><span style="color: #7D9029">getHeaderId</span><span style="color: #666666">()</span> <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;)&quot;</span><span style="color: #666666">);</span>
                    <span style="color: #666666">}</span>
                <span style="color: #666666">},</span> <span style="color: #008000; font-weight: bold">new</span> Response<span style="color: #666666">.</span><span style="color: #7D9029">ErrorListener</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
            <span style="color: #AA22FF">@Override</span>
            <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">onErrorResponse</span><span style="color: #666666">(</span>VolleyError error<span style="color: #666666">)</span> <span style="color: #666666">{</span>
                Log<span style="color: #666666">.</span><span style="color: #7D9029">i</span><span style="color: #666666">(</span>StreamingActivity<span style="color: #666666">.</span><span style="color: #7D9029">TAG</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;sendToServer didn&#39;t work!&quot;</span><span style="color: #666666">);</span>
                Log<span style="color: #666666">.</span><span style="color: #7D9029">i</span><span style="color: #666666">(</span>StreamingActivity<span style="color: #666666">.</span><span style="color: #7D9029">TAG</span><span style="color: #666666">,</span> error<span style="color: #666666">.</span><span style="color: #7D9029">toString</span><span style="color: #666666">());</span>
            <span style="color: #666666">}</span>
        <span style="color: #666666">},</span> UUID<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">);</span>
        <span style="color: #408080; font-style: italic">// avoid sending the data twice (big message over a slow network)</span>
        postRequest<span style="color: #666666">.</span><span style="color: #7D9029">setRetryPolicy</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> DefaultRetryPolicy<span style="color: #666666">(0,</span>
                DefaultRetryPolicy<span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_MAX_RETRIES</span><span style="color: #666666">,</span>
                DefaultRetryPolicy<span style="color: #666666">.</span><span style="color: #7D9029">DEFAULT_BACKOFF_MULT</span><span style="color: #666666">));</span>
        <span style="color: #408080; font-style: italic">// Add the request to the RequestQueue.</span>
        queue<span style="color: #666666">.</span><span style="color: #7D9029">add</span><span style="color: #666666">(</span>postRequest<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>
  </pre></div>
  <ul>
    <li>Finally for the upstream service, find below the task that regularly checks if there is new data in the cache, and if there is, it adds
      a new item to the list of pending requests. (Note that there is another scheduled task that actually sends the data upstream to the server)</li>
  </ul>
  <!-- HTML generated using hilite.me --><div style="background: #f8f8f8; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">checkCacheDataStream</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
          <span style="color: #008000; font-weight: bold">final</span> Runnable checkData <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> Runnable<span style="color: #666666">()</span> <span style="color: #666666">{</span>
              <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">run</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
                  AccDataCacheSingleton obj <span style="color: #666666">=</span> AccDataCacheSingleton<span style="color: #666666">.</span><span style="color: #7D9029">getInstance</span><span style="color: #666666">();</span>
                  Collection<span style="color: #666666">&lt;</span>FraaStreamData<span style="color: #666666">&gt;</span> list <span style="color: #666666">=</span> convertWithMaxDataSize<span style="color: #666666">(</span>obj<span style="color: #666666">.</span><span style="color: #7D9029">selectRowsHeaderEqualTo</span><span style="color: #666666">(</span>getHeaderId<span style="color: #666666">()));</span>
                  <span style="color: #B00040">boolean</span> dataPending <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">false</span><span style="color: #666666">;</span>
                  <span style="color: #008000; font-weight: bold">for</span> <span style="color: #666666">(</span>FraaStreamData data <span style="color: #666666">:</span> list<span style="color: #666666">)</span> <span style="color: #666666">{</span>
                      <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>data<span style="color: #666666">.</span><span style="color: #7D9029">getDataUnits</span><span style="color: #666666">().</span><span style="color: #7D9029">length</span> <span style="color: #666666">==</span> MAX_NUMBER_DATA_UNITS_UPSTREAM<span style="color: #666666">)</span> <span style="color: #666666">{</span>
                          addDataToPendingRequests<span style="color: #666666">(</span>data<span style="color: #666666">);</span>
                          dataPending <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">true</span><span style="color: #666666">;</span>
                      <span style="color: #666666">}</span>
                  <span style="color: #666666">}</span>
                  <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>dataPending <span style="color: #666666">&amp;&amp;</span> dataProcessHandle<span style="color: #666666">.</span><span style="color: #7D9029">isCancelled</span><span style="color: #666666">())</span> <span style="color: #666666">{</span>
                      Log<span style="color: #666666">.</span><span style="color: #7D9029">d</span><span style="color: #666666">(</span>StreamingActivity<span style="color: #666666">.</span><span style="color: #7D9029">TAG</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;restarting data process&quot;</span><span style="color: #666666">);</span>
                      checkDataEveryInterval<span style="color: #666666">();</span>
                  <span style="color: #666666">}</span>
              <span style="color: #666666">}</span>
          <span style="color: #666666">};</span>
          <span style="color: #408080; font-style: italic">// runs every 2 minutes, never stops</span>
          <span style="color: #408080; font-style: italic">// TODO adjust time interval depending on size of buffers &amp; sampling rate</span>
          cacheScheduler<span style="color: #666666">.</span><span style="color: #7D9029">scheduleAtFixedRate</span><span style="color: #666666">(</span>checkData<span style="color: #666666">,</span> <span style="color: #666666">0,</span> <span style="color: #666666">2,</span> TimeUnit<span style="color: #666666">.</span><span style="color: #7D9029">MINUTES</span><span style="color: #666666">);</span>
      <span style="color: #666666">}</span>
  </pre></div>
  <h4>Note on the server</h4>
  <p>You can find the full code <a href="https://github.com/lrnzcig/fraa/tree/master/FraaStreamServer">here</a>.
    The server just does enough to handle the REST requests and flush the data into a database. It is implemented in Java, using Hibernate for handling
    the database. It uses maven to produce a war file, which may be deployed e.g. using tomcat.</p>


    <div class="aside-widget">
        <header>
            <h3>Related posts</h3>
        </header>
        <div class="body">
            <ul class="tales-list">
              <li><a href="2016-10-30-wearable-robust.html">Upstreaming data from a wearable device to a server: making a robust Android app for the lab</a>
              </br>Some conclusions on how to make the app robust enough, so that the users can do whatever they like with their smartphones during the experiment.
              </li>
              <li><a href="2016-11-05-wearable-physical-activity.html">Wearables: measuring physical activity from accelerometer data</a>
                </br>The very first analysis to try for the data coming from an accelerometer: measuring the physical activity of the user. Actually, the simplest statictic measures already tell a lot -in particular the standard deviation of the Signal Vector Magnitude (i.e. the modulus).
              </li>
              <li><a href="2017-01-07-time-series-neural-net.html">Applying neural nets to time series: accelerometer data from wearable</a>
                </br>When approaching a somehow more advanced analysis of the data coming from an accelerometer, the far-from-obvious concepts from time series start to be needed. But are they really needed? Maybe not, since one could always apply a neural network for solving the problem. Is this second path easier in practice?
              </li>
            </ul>
        </div>
    </div>

  </div><!-- main container -->
</span><!-- article -->

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

<!-- disqus comments -->
<div class="widewrapper main">
<div class="container">
    <div class="row">
        <div class="col-md-12">

<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//sisifospage.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
<!-- disqus comment count (?) -->
<script id="dsq-count-scr" src="//sisifospage.disqus.com/count.js" async></script>

        </div>
    </div>
</div>
</div>
<!-- end disqus -->


<!-- back to Thales to add footer -->
<footer>
    <div class="widewrapper footer">
        <div class="container">
            <div class="row">
                <div class="col-md-4 footer-widget">
                    <h3> <i class="fa fa-envelope"></i>Contact us</h3>

                    <span>Happy to get any feedback:</span>

                    <span class="email">
                        <a href="#"><span itemprop="author" itemscope itemtype="http://schema.org/Person">
                              <span itemprop="name">sisifospage@gmail.com</a>
                    </span>
                </div>
            </div>
        </div>
    </div>
    <div class="widewrapper copyright">
        <div class="container">
            <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/80x15.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
        </div>
    </div>
</footer>

<script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="modules/modernizr/modernizr-custom.js"></script>
</body>
</html>
